<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Tr·∫Øc nghi·ªám</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <p id="timer">‚è± Th·ªùi gian: 00:00:00</p>
    <p id="score">ƒê√∫ng: 0 / 0</p>

    <div class="quiz-container">
      <h2 id="q-number"></h2>
      <p id="question"></p>
      <form id="options"></form>
      <p id="answer" class="hidden"></p>
    </div>

    <div class="controls">
      <button onclick="goHome()">üè† Trang ch·ªß</button>

      <button onclick="prevQuestion()">‚¨Ö Quay l·∫°i</button>
      <button onclick="checkAnswer()">‚úî X√°c nh·∫≠n</button>
      <button onclick="nextQuestion()">‚û° Ti·∫øp</button>
      <button id="reviewBtn" onclick="startReview()" disabled>
        üîÅ √în t·∫≠p c√¢u sai
      </button>
      <button id="backBtn" onclick="backToQuiz()" class="hidden">
        üîô Quay l·∫°i b√†i l√†m
      </button>
    </div>

    <script src="data.js"></script>
    <script>
      /* ===== BI·∫æN ===== */
      const allQuestions = [...quizData.all];
      let questions = [];
      let index = 0;

      let answered = [];
      let userAnswers = [];
      let correctCount = 0;
      let wrongQuestions = [];

      let reviewMode = false;

      let time = 0;
      let timer = null;

      /* ===== SHUFFLE ===== */
      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
      }

      shuffle(allQuestions);
      questions = [...allQuestions];

      answered = Array(questions.length).fill(false);
      userAnswers = Array(questions.length).fill(null);

      /* ===== TIMER ===== */
      function startTimer() {
        timer = setInterval(() => {
          time++;
          const h = String(Math.floor(time / 3600)).padStart(2, "0");
          const m = String(Math.floor((time % 3600) / 60)).padStart(2, "0");
          const s = String(time % 60).padStart(2, "0");
          document.getElementById(
            "timer"
          ).innerText = `‚è± Th·ªùi gian: ${h}:${m}:${s}`;
        }, 1000);
      }

      /* ===== RENDER ===== */
      function render() {
        const q = questions[index];

        document.getElementById("q-number").innerText = reviewMode
          ? `√în t·∫≠p c√¢u sai: ${index + 1}/${questions.length}`
          : `C√¢u ${index + 1}/${questions.length}`;

        document.getElementById("question").innerText = q.question;

        const optDiv = document.getElementById("options");
        optDiv.innerHTML = "";

        for (let k in q.options) {
          optDiv.innerHTML += `
          <label class="option">
            <input type="radio" name="opt" value="${k}"
              ${userAnswers[index] === k ? "checked" : ""}
              ${answered[index] && !reviewMode ? "disabled" : ""}>
            ${k}. ${q.options[k]}
          </label>`;
        }

        document.getElementById("answer").classList.add("hidden");

        document.getElementById("score").innerText = reviewMode
          ? `√în t·∫≠p: ${questions.length} c√¢u`
          : `ƒê√∫ng: ${correctCount}/${allQuestions.length}`;
      }

      /* ===== CHECK ===== */
      function checkAnswer() {
        if (!reviewMode && answered[index]) return;

        const radios = document.querySelectorAll("input[name='opt']");
        let selected = null;
        radios.forEach((r) => {
          if (r.checked) selected = r.value;
        });

        if (!selected) return alert("B·∫°n ch∆∞a ch·ªçn ƒë√°p √°n!");

        const q = questions[index];

        if (!reviewMode) {
          answered[index] = true;
          userAnswers[index] = selected;

          if (selected === q.correct) {
            correctCount++;
          } else {
            if (!wrongQuestions.includes(q)) {
              wrongQuestions.push(q);
            }
            document.getElementById("reviewBtn").disabled = false;
          }
          document.getElementById(
            "score"
          ).innerText = `ƒê√∫ng: ${correctCount} / ${questions.length}`;

          if (answered.every((a) => a)) finishQuiz();
        }

        radios.forEach((r) => {
          const label = r.parentElement;
          if (r.value === q.correct) label.classList.add("correct");
          if (r.checked && r.value !== q.correct) label.classList.add("wrong");
          r.disabled = true;
        });

        document.getElementById(
          "answer"
        ).innerHTML = `ƒê√°p √°n ƒë√∫ng: <b>${q.correct}</b>`;
        document.getElementById("answer").classList.remove("hidden");
      }

      /* ===== NAV ===== */
      function nextQuestion() {
        if (index < questions.length - 1) {
          index++;
          render();
        }
      }

      function prevQuestion() {
        if (index > 0) {
          index--;
          render();
        }
      }

      /* ===== REVIEW MODE ===== */
      function startReview() {
        if (wrongQuestions.length === 0) return;

        reviewMode = true;
        questions = [...wrongQuestions];
        index = 0;

        document.getElementById("reviewBtn").classList.add("hidden");
        document.getElementById("backBtn").classList.remove("hidden");

        render();
      }

      function backToQuiz() {
        reviewMode = false;
        questions = [...allQuestions];
        index = 0;

        document.getElementById("reviewBtn").classList.remove("hidden");
        document.getElementById("backBtn").classList.add("hidden");

        render();
      }
      function goHome() {
        if (confirm("Quay v·ªÅ trang ch·ªß? Ti·∫øn tr√¨nh s·∫Ω m·∫•t.")) {
          clearInterval(timer);
          window.location.href = "index.html";
        }
      }

      startTimer();
      render();
    </script>
  </body>
</html>
